<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit} ? 'Chỉnh sửa Khuyến mãi' : 'Thêm Khuyến mãi'">Thêm Khuyến mãi - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/admin/promotions.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .main-content {
            margin-left: 0;
            padding: 20px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- Temporary: Remove layout includes for debugging -->
    <!-- <div th:replace="~{layouts/sidebar :: sidebar}"></div> -->

    <div class="main-content">
        <!-- <div th:replace="~{layouts/header :: header}"></div> -->

        <div class="container-fluid py-4">
            <!-- Header Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-percentage text-primary me-2"></i>
                                <span th:text="${isEdit} ? 'Chỉnh sửa Khuyến mãi' : 'Thêm Khuyến mãi'">Thêm Khuyến
                                    mãi</span>
                            </h2>
                            <p class="text-muted mb-0">
                                <span
                                    th:text="${isEdit} ? 'Cập nhật thông tin khuyến mãi' : 'Tạo chương trình khuyến mãi mới'">Tạo
                                    chương trình khuyến mãi mới</span>
                            </p>
                        </div>
                        <a href="/admin/promotions" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Quay lại
                        </a>
                    </div>
                </div>
            </div>

            <!-- Debug Info (Hidden) -->
            <div class="alert alert-info" style="display: none;">
                <strong>Debug Info:</strong>
                <p>isEdit: <span th:text="${isEdit}">false</span></p>
                <p>promotion: <span th:text="${promotion}">null</span></p>
                <p>Current time: <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')}">now</span>
                </p>
            </div>

            <!-- Alert Messages -->
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row">
                <!-- Form Section -->
                <div class="col-lg-8">
                    <form
                        th:action="${isEdit} ? @{/admin/promotions/edit/{id}(id=${promotion.id})} : @{/admin/promotions/create}"
                        th:object="${promotion}" method="post" id="promotionForm">

                        <!-- Basic Information -->
                        <div class="form-section">
                            <h5>
                                <i class="fas fa-info-circle me-2"></i>
                                Thông tin cơ bản
                            </h5>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="name" th:field="*{name}"
                                            placeholder="Tên khuyến mãi" required>
                                        <label for="name" class="required-field">Tên khuyến mãi</label>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập tên khuyến mãi
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        <input type="number" class="form-control" id="discountPercent"
                                            th:field="*{discountPercent}" placeholder="Phần trăm giảm giá" min="1"
                                            max="100" required>
                                        <label for="discountPercent" class="required-field">Phần trăm giảm giá
                                            (%)</label>
                                        <div class="invalid-feedback">
                                            Phần trăm giảm giá phải từ 1-100
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="description" th:field="*{description}"
                                    placeholder="Mô tả khuyến mãi" style="height: 100px"></textarea>
                                <label for="description">Mô tả khuyến mãi</label>
                            </div>
                        </div>

                        <!-- Time Settings -->
                        <div class="form-section">
                            <h5>
                                <i class="fas fa-clock me-2"></i>
                                Thời gian áp dụng
                            </h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <div class="date-time-input">
                                            <input type="datetime-local" class="form-control" id="startDate"
                                                th:field="*{startDate}" required>
                                            <i class="fas fa-calendar-alt form-icon"></i>
                                        </div>
                                        <label for="startDate" class="required-field">Ngày bắt đầu</label>
                                        <div class="invalid-feedback">
                                            Vui lòng chọn ngày bắt đầu
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <div class="date-time-input">
                                            <input type="datetime-local" class="form-control" id="endDate"
                                                th:field="*{endDate}" required>
                                            <i class="fas fa-calendar-alt form-icon"></i>
                                        </div>
                                        <label for="endDate" class="required-field">Ngày kết thúc</label>
                                        <div class="invalid-feedback">
                                            Vui lòng chọn ngày kết thúc
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="/admin/promotions" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                Hủy
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-info me-2" onclick="previewPromotion()">
                                    <i class="fas fa-eye me-2"></i>
                                    Xem trước
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    <span th:text="${isEdit} ? 'Cập nhật' : 'Tạo khuyến mãi'">Tạo khuyến mãi</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Preview Section -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2"></i>
                                Xem trước
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="preview-card" id="previewCard">
                                <i class="fas fa-percentage fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">Nhập thông tin để xem trước</h6>
                            </div>

                            <div class="mt-3">
                                <h6 class="text-muted">Hướng dẫn:</h6>
                                <ul class="list-unstyled small text-muted">
                                    <li><i class="fas fa-check text-success me-2"></i>Tên khuyến mãi phải rõ ràng, dễ
                                        hiểu</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Phần trăm giảm giá từ 1-100%</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Ngày kết thúc phải sau ngày bắt
                                        đầu</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Mô tả giúp khách hàng hiểu rõ ưu
                                        đãi</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Form validation
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Set minimum date to today
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const today = now.toISOString().slice(0, 16);

            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;

            // Update end date minimum when start date changes
            document.getElementById('startDate').addEventListener('change', function () {
                document.getElementById('endDate').min = this.value;
            });
        });

        // Preview function
        function previewPromotion() {
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const discountPercent = document.getElementById('discountPercent').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const isActive = true; // Always true for preview

            const previewCard = document.getElementById('previewCard');

            if (name && discountPercent) {
                previewCard.innerHTML = `
                    <div class="text-center">
                        <div class="mb-3">
                            <span class="badge bg-danger fs-6">-${discountPercent}%</span>
                        </div>
                        <h5 class="mb-2">${name}</h5>
                        ${description ? `<p class="text-muted small mb-2">${description}</p>` : ''}
                        <div class="small text-muted">
                            <div><i class="fas fa-calendar-alt me-1"></i> Từ: ${formatDateTime(startDate)}</div>
                            <div><i class="fas fa-calendar-alt me-1"></i> Đến: ${formatDateTime(endDate)}</div>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-success">
                                Đang hoạt động
                            </span>
                        </div>
                    </div>
                `;
                previewCard.classList.add('has-content');
            } else {
                previewCard.innerHTML = `
                    <i class="fas fa-percentage fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Nhập tên và phần trăm giảm giá để xem trước</h6>
                `;
                previewCard.classList.remove('has-content');
            }
        }

        // Format datetime for display
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Auto preview on input change
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = ['name', 'description', 'discountPercent', 'startDate', 'endDate'];
            inputs.forEach(function (inputId) {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', previewPromotion);
                    input.addEventListener('change', previewPromotion);
                }
            });
        });

        // Form submission with AJAX
        document.getElementById('promotionForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo...';
            submitBtn.disabled = true;

            // Send AJAX request to API
            const promotionData = {
                name: formData.get('name'),
                description: formData.get('description'),
                discountPercent: parseInt(formData.get('discountPercent')),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                isActive: true
            };

            fetch('/api/promotions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(promotionData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Success - show notification
                        showSuccessNotification(data.message || 'Thêm khuyến mãi thành công!');
                        // Reset form
                        this.reset();
                        // Reset preview
                        previewPromotion();
                    } else {
                        // Error - show error message
                        showErrorNotification(data.message || 'Có lỗi xảy ra khi tạo khuyến mãi!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorNotification('Có lỗi xảy ra khi tạo khuyến mãi!');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Show success notification
        function showSuccessNotification(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Show error notification
        function showErrorNotification(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>

</html>