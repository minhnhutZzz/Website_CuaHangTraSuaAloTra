<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Khuyến mãi - Simple</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">
            <i class="fas fa-percentage text-primary me-2"></i>
            Thêm Khuyến mãi
        </h1>

        <div class="row">
            <div class="col-md-8">
                <form th:action="@{/admin/promotions/create}" th:object="${promotion}" method="post" id="promotionForm">

                    <div class="card">
                        <div class="card-header">
                            <h5>Thông tin khuyến mãi</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Tên khuyến mãi *</label>
                                        <input type="text" class="form-control" id="name" th:field="*{name}"
                                            placeholder="Nhập tên khuyến mãi" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="discountPercent" class="form-label">Phần trăm giảm giá (%) *</label>
                                        <input type="number" class="form-control" id="discountPercent"
                                            th:field="*{discountPercent}" placeholder="0" min="1" max="100" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">Mô tả</label>
                                <textarea class="form-control" id="description" th:field="*{description}" rows="3"
                                    placeholder="Nhập mô tả khuyến mãi"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">Ngày bắt đầu *</label>
                                        <input type="datetime-local" class="form-control" id="startDate"
                                            th:field="*{startDate}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">Ngày kết thúc *</label>
                                        <input type="datetime-local" class="form-control" id="endDate"
                                            th:field="*{endDate}" required>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Tạo khuyến mãi
                        </button>
                        <button type="button" class="btn btn-outline-dark ms-2" onclick="history.back()">
                            <i class="fas fa-arrow-left me-2"></i>
                            Quay lại
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="preview">
                            <h6 id="previewName">Tên khuyến mãi</h6>
                            <p id="previewDescription" class="text-muted">Mô tả khuyến mãi</p>
                            <div class="d-flex justify-content-between">
                                <span>Giảm giá:</span>
                                <span id="previewDiscount" class="text-danger fw-bold">0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Bắt đầu:</span>
                                <span id="previewStartDate">--</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Kết thúc:</span>
                                <span id="previewEndDate">--</span>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-success" id="previewStatus">Hoạt động</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Real-time preview
        function updatePreview() {
            const name = document.getElementById('name').value || 'Tên khuyến mãi';
            const description = document.getElementById('description').value || 'Mô tả khuyến mãi';
            const discount = document.getElementById('discountPercent').value || '0';
            const startDate = document.getElementById('startDate').value || '--';
            const endDate = document.getElementById('endDate').value || '--';
            // isActive luôn true, bỏ truy cập DOM checkbox đã bị xóa
            const isActive = true;

            document.getElementById('previewName').textContent = name;
            document.getElementById('previewDescription').textContent = description;
            document.getElementById('previewDiscount').textContent = discount + '%';
            document.getElementById('previewStartDate').textContent = startDate;
            document.getElementById('previewEndDate').textContent = endDate;

            const statusBadge = document.getElementById('previewStatus');
            if (isActive) {
                statusBadge.textContent = 'Hoạt động';
                statusBadge.className = 'badge bg-success';
            } else {
                statusBadge.textContent = 'Tạm dừng';
                statusBadge.className = 'badge bg-secondary';
            }
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = ['name', 'description', 'discountPercent', 'startDate', 'endDate'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
                document.getElementById(id).addEventListener('change', updatePreview);
            });

            // Set default dates
            const now = new Date();
            const today = now.toISOString().slice(0, 16);
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000).toISOString().slice(0, 16);

            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = tomorrow;

            // Initial preview
            updatePreview();
        });

        // Form submission with AJAX
        document.getElementById('promotionForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo...';
            submitBtn.disabled = true;

            const promotionData = {
                name: formData.get('name'),
                description: formData.get('description'),
                discountPercent: parseInt(formData.get('discountPercent')),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                isActive: true
            };

            fetch('/api/promotions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(promotionData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        showNotification(data.message || 'Thêm khuyến mãi thành công!', 'success');
                        this.reset();
                        updatePreview();
                    } else {
                        showNotification((data && data.message) ? data.message : 'Có lỗi xảy ra khi tạo khuyến mãi!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Có lỗi xảy ra khi tạo khuyến mãi!', 'error');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        });

        function showNotification(message, type) {
            // Clear all existing alerts before showing a new one
            document.querySelectorAll('.alert-dismissible').forEach(alert => alert.remove());
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <strong>${type === 'success' ? 'Thành công!' : 'Lỗi!'}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>

</html>