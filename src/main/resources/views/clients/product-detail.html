<div th:replace="~{layouts/main-layout :: layout('Chi tiết sản phẩm - TRÀ SỮA MONA', ~{::content})}">
    <div th:fragment="content">
        <main class="container mx-auto px-4 py-8 flex flex-col">
            <div class="flex gap-8 items-start">
                <!-- Gallery -->
                <section id="product-gallery" class="w-[50%] bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden relative self-start">
                    <span class="badge-sale z-10">SALE!</span>

                    <!-- Swiper Main -->
                    <div class="swiper pd-main">
                        <div class="swiper-wrapper" id="pdMainWrapper">
                            <div class="swiper-slide">
                                <div class="w-full h-96 bg-gray-200 animate-pulse flex items-center justify-center">
                                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Swiper Thumbs -->
                    <div class="swiper pd-thumbs">
                        <div class="swiper-wrapper" id="pdThumbsWrapper">
                            <div class="swiper-slide">
                                <div class="w-full h-20 bg-gray-200 animate-pulse rounded"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Info -->
                <section id="product-info" class="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between h-full">
                    <!-- Error Message -->
                    <div th:if="${error != null}" class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded text-sm mb-4">
                        <span th:text="${error}"></span>
                    </div>

                    <!-- Product Data -->
                    <div id="product-data" class="flex flex-col h-full">
                        <div id="product-loading" class="flex flex-col h-full">
                            <div class="mb-6"><div class="animate-pulse"><div class="h-8 bg-gray-200 rounded mb-3"></div></div></div>
                            <div class="mb-6"><div class="animate-pulse"><div class="flex items-center gap-3 mb-4"><div class="h-10 w-32 bg-gray-200 rounded-lg"></div></div></div></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tabs -->
            <div class="mt-10 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center gap-6 border-b mb-6">
                    <button class="py-3 font-bold text-[#cb5439] border-b-2 border-[#cb5439]" onclick="showTab('desc')">MÔ TẢ</button>
                    <button class="py-3 font-bold text-gray-600 hover:text-[#cb5439] border-b-2 border-transparent" onclick="showTab('info')">THÔNG TIN BỔ SUNG</button>
                    <button class="py-3 font-bold text-gray-600 hover:text-[#cb5439] border-b-2 border-transparent" onclick="showTab('review')">
                        ĐÁNH GIÁ (<span id="reviewCount">0</span>)
                    </button>
                </div>

                <!-- Mô tả -->
                <div id="tab-desc" class="text-gray-700 leading-relaxed">
                    <p class="mb-4">Đang tải mô tả sản phẩm...</p>
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-4 mt-4">
                        <h4 class="font-semibold text-[#1f2d3d] mb-2 flex items-center">
                            <i class="fas fa-coffee text-amber-600 mr-2"></i>
                            Mô tả sản phẩm
                        </h4>
                        <p class="text-sm text-gray-600">
                            Trà sữa truyền thống với hương vị đậm đà, được pha chế từ trà đen cao cấp và sữa tươi nguyên chất. 
                            Topping trân châu dai giòn, thạch mềm mịn tạo nên sự hài hòa hoàn hảo. 
                            Sản phẩm được phục vụ tươi ngon, có thể tùy chỉnh độ ngọt và lượng đá theo sở thích.
                        </p>
                    </div>
                </div>

                <!-- Thông tin bổ sung -->
                <div id="tab-info" class="text-gray-700 leading-relaxed hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                            <tbody>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="w-1/3 font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Loại đồ uống</td><td class="p-3 border-b border-gray-200">Trà sữa</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Kích thước</td><td class="p-3 border-b border-gray-200">S (350ml), M (500ml), L (650ml)</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Độ ngọt</td><td class="p-3 border-b border-gray-200">0%, 25%, 50%, 75%, 100%</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Đá</td><td class="p-3 border-b border-gray-200">Không đá, Ít đá, Bình thường, Nhiều đá</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Topping</td><td class="p-3 border-b border-gray-200">Trân châu, Thạch, Pudding, Kem cheese</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Nhiệt độ phục vụ</td><td class="p-3 border-b border-gray-200">Lạnh, Nóng</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Thời gian chuẩn bị</td><td class="p-3 border-b border-gray-200">5-10 phút</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3 border-b border-gray-200">Bảo quản</td><td class="p-3 border-b border-gray-200">Sử dụng trong 2 giờ sau khi nhận được hàng</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3">Mã sản phẩm</td><td class="p-3">TS001</td></tr>
                            <tr class="odd:bg-white even:bg-gray-50"><td class="font-medium text-[#1f2d3d] p-3">TỪ KHÓA:</td><td class="p-3">Trà sữa, Sữa tươi, Trà xanh, Yakult</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Thông tin dinh dưỡng -->
                    <div class="mt-6 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-4">
                        <h4 class="font-semibold text-[#1f2d3d] mb-3 flex items-center">
                            <i class="fas fa-leaf text-green-500 mr-2"></i>
                            Thông tin dinh dưỡng (cho 500ml)
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Calories:</span>
                                <span class="font-medium">250-350 kcal</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Đường:</span>
                                <span class="font-medium">25-40g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Chất béo:</span>
                                <span class="font-medium">8-12g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Protein:</span>
                                <span class="font-medium">3-5g</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lưu ý đặc biệt -->
                    <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Lưu ý:</strong> Sản phẩm có chứa lactose. Không phù hợp cho người dị ứng sữa. 
                                    Có thể tùy chỉnh độ ngọt và topping theo yêu cầu.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Đánh giá -->
                <div id="tab-review" class="hidden">
                    <!-- Form đánh giá -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold text-[#1f2d3d] mb-4">Viết đánh giá của bạn</h4>
                        <div id="reviewAuthCheck" class="mb-4">
                            <!-- Sẽ được cập nhật bởi JavaScript -->
                        </div>
                        <form id="reviewForm" class="space-y-4" style="display: none;">
                            <div>
                                <label class="block text-sm text-gray-700 mb-2">Đánh giá *</label>
                                <div id="rvStars" class="flex gap-1 text-xl text-gray-300 cursor-pointer select-none">
                                    <i data-v="1" class="fa-solid fa-star"></i>
                                    <i data-v="2" class="fa-solid fa-star"></i>
                                    <i data-v="3" class="fa-solid fa-star"></i>
                                    <i data-v="4" class="fa-solid fa-star"></i>
                                    <i data-v="5" class="fa-solid fa-star"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Nội dung đánh giá *</label>
                                <textarea rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#cb5439]" placeholder="Hãy chia sẻ cảm nhận của bạn..." required></textarea>
                            </div>
                            <button type="submit" class="bg-[#cb5439] text-white px-5 py-2 rounded-full hover:bg-[#a8442f] transition-colors">GỬI ĐÁNH GIÁ</button>
                        </form>
                    </div>

                    <!-- Danh sách đánh giá -->
                    <div id="reviews-list">
                        <p class="text-gray-500 text-center py-8">Chưa có đánh giá nào.</p>
                    </div>
                </div>
            </div>

            <!-- Sản phẩm liên quan -->
            <section class="mt-10">
                <h2 class="text-2xl font-bold text-center text-[#2f604a] mb-6">SẢN PHẨM LIÊN QUAN</h2>
                <div id="relatedProducts" class="grid grid-cols-5 gap-4">
                    <div class="col-span-5 flex justify-center items-center py-8">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#cb5439]"></div>
                            <span class="text-gray-600">Đang tải sản phẩm liên quan...</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<!-- JS -->
<script defer src="/js/client/productDetail/utils.js"></script>
<script defer src="/js/client/productDetail/cart.js"></script>
<script defer src="/js/client/productDetail/product-data.js"></script>
<script defer src="/js/client/productDetail/related-products.js"></script>
<script defer src="/js/client/productDetail/ui.js"></script>
<script defer src="/js/client/productDetail/swiper.js"></script>
<script defer src="/js/client/productDetail/main.js"></script>

<!-- Đánh giá JS -->
<script>
    // Xử lý sao
    document.querySelectorAll('#rvStars i').forEach(star => {
        star.addEventListener('click', () => {
            const value = star.getAttribute('data-v');
            document.querySelectorAll('#rvStars i').forEach((s, i) => {
                s.className = i < value ? 'fa-solid fa-star text-yellow-400' : 'fa-solid fa-star text-gray-300';
            });
        });
    });

    // Kiểm tra authentication và hiển thị form
    async function checkAuthAndShowForm() {
        const authCheckDiv = document.getElementById('reviewAuthCheck');
        const reviewForm = document.getElementById('reviewForm');
        
        try {
            // Lấy token từ localStorage hoặc sessionStorage
            const token = localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken');
            
            if (!token) {
                authCheckDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                            <div>
                                <p class="text-yellow-800 font-medium">Bạn cần đăng nhập để đánh giá sản phẩm</p>
                                <p class="text-yellow-700 text-sm mt-1">
                                    <a href="/auth/login" class="text-[#cb5439] hover:underline">Đăng nhập ngay</a> 
                                    hoặc <a href="/auth/register" class="text-[#cb5439] hover:underline">Đăng ký tài khoản</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Kiểm tra token có hợp lệ không
            const response = await fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    authCheckDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-green-800 font-medium">Xin chào ${result.data.name || result.data.email}!</p>
                                    <p class="text-green-700 text-sm">Bạn có thể đánh giá sản phẩm này</p>
                                </div>
                            </div>
                        </div>
                    `;
                    reviewForm.style.display = 'block';
                } else {
                    throw new Error('Invalid token');
                }
            } else {
                throw new Error('Token expired');
            }
        } catch (err) {
            console.error('Auth check failed:', err);
            authCheckDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-600 mr-3"></i>
                        <div>
                            <p class="text-red-800 font-medium">Phiên đăng nhập đã hết hạn</p>
                            <p class="text-red-700 text-sm mt-1">
                                <a href="/auth/login" class="text-[#cb5439] hover:underline">Đăng nhập lại</a>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Gửi đánh giá
    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const rating = document.querySelectorAll('#rvStars i.text-yellow-400').length;
        const comment = this.querySelector('textarea').value.trim();

        if (rating === 0 || !comment) {
            alert('Vui lòng chọn đánh giá và nhập nội dung!');
            return;
        }

        const productId = window.location.pathname.split('/').pop();
        const token = localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken');

        try {
            const response = await fetch(`/api/reviews/product/${productId}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ rating, comment })
            });

            const result = await response.json();

            if (result.success) {
                alert('Cảm ơn bạn đã đánh giá!');
                this.reset();
                document.querySelectorAll('#rvStars i').forEach(s => s.className = 'fa-solid fa-star text-gray-300');
                loadReviews();
            } else {
                alert('Lỗi: ' + result.message);
            }
        } catch (err) {
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
            console.error(err);
        }
    });

    // Tải đánh giá
    async function loadReviews() {
        const productId = window.location.pathname.split('/').pop();
        try {
            const response = await fetch(`/api/reviews/product/${productId}`);
            const result = await response.json();
            if (result.success) {
                renderReviews(result.data);
                updateReviewCount(result.data.length);
            }
        } catch (err) {
            console.error('Load reviews error:', err);
        }
    }

    function renderReviews(reviews) {
        const container = document.getElementById('reviews-list');
        if (reviews.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Chưa có đánh giá nào.</p>';
            return;
        }

        container.innerHTML = reviews.map(r => `
      <div class="border-b pb-4 mb-4 last:border-0">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="font-semibold text-gray-800">${r.name || 'Khách hàng'}</p>
            <p class="text-sm text-gray-500">${new Date(r.createdAt).toLocaleDateString('vi-VN')}</p>
          </div>
          <div class="flex text-yellow-400">
            ${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}
          </div>
        </div>
        <p class="text-gray-700">${r.comment}</p>
      </div>
    `).join('');
    }

    function updateReviewCount(count) {
        document.querySelector('button[onclick="showTab(\'review\')"] span').textContent = count;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadReviews();
        checkAuthAndShowForm();
    });
</script>